<!DOCTYPE html> 
<html> 
<head> 
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no" /> 
    <meta http-equiv="content-type" content="text/html; charset=UTF-8"/> 
    <style type="text/css"> 
    html { height: 100% }
    body { 
        height: 100%; 
        margin: 0px; 
        padding: 0px;
        font-family:helvetica; 
        background-color:#333; 
        color: white; 
        font-family:helvetica; 
        font-size:0.8em;
    }
    #map_canvas { 
        height: 100% 
    }
    #info {
        z-index: 100;
        width: 100%;
        background-color:#333;
        font-size: 1.0em;
        position: absolute; 
        top:0; 
        padding:5px 10px 5px 10px;
    }
    #info a {
        color: white; 
    }
    #info img {
        padding: 0px 5px 0px 0px;
        vertical-align:middle;
        height:24px;
    }
    </style> 
    <title></title> 
    <script src="http://ajax.googleapis.com/ajax/libs/jquery/1/jquery.min.js"></script>
    <script type="text/javascript" src="http://maps.google.com/maps/api/js?sensor=false"></script> 
    <script type="text/javascript" src="http://s3.amazonaws.com/le_bazar_de_julien/xmlDOM/jquery.xmldom.js"></script>

    <script type="text/javascript"> 

    function initialize() {
    }
        
    </script> 
</head> 
<body onload="initialize()"> 
    <div id="info">Built by <img src="http://www.gravatar.com/avatar/a2f7d4dd6df7dd59e4adab811c00a3a1?s=24"><a href="http://superfeedr.com" style="color:#CCC">Superfeedr</a> with data from <img src="http://bluwiki.com/images/8/89/IconGowallaCling.png"><a href="http://gowalla.com/">Gowalla</a>, using PubSubHubbub, Node.JS and WebSockets. <em>In only works if you have a modern browser which supports WebSockets!</em>
    </div>
    <div id="map_canvas"></div> 
    <a href="http://github.com/julien51/socket-sub"><img style="position: absolute; top: 0; right: 0; border: 0; z-index:200" src="http://s3.amazonaws.com/github/ribbons/forkme_right_orange_ff7600.png" alt="Fork me on GitHub" /></a> 
    
    <script>
    $(document).ready(function() {
        
        var lat      = 41.900297;
        var lon      = 12.47077
        var myLatlng = new google.maps.LatLng(lat, lon);
        
        var myOptions = {
            zoom: 3,
            center: myLatlng,
            mapTypeId: google.maps.MapTypeId.TERRAIN
        }
        var map = new google.maps.Map(document.getElementById("map_canvas"), myOptions);
        
        var conn = {},
            serverUri;
        
        var point_buffer = new Array(); 
        var live_points  = new Array();
        
        // Displays the points in a 1Hz frequency. Faster than this, people wouldn't see the updates.
        setInterval(function() {
            var point = point_buffer.shift()
            if(point) {
                point.setMap(map);
                map.panTo(point.getPosition());
                live_points.push(point);
                if(live_points.length > 20) {
                    var old_point = live_points.shift()
                    old_point.setVisible(false);
                    delete old_point;
                }
            }
        }, 1000);
        
        function startConnection() {
            var host = "node.superfeedr.com",
            port = 27261;
            serverUri = "ws://"+host+":"+port;
            openConnection();
        }

        function openConnection() {
            if ( !conn.readyState || conn.readyState > 1 ) {

                conn = new WebSocket( serverUri );

                conn.onopen = function () {
                    conn.send("http://hub.gowalla.com/track/gowalla");
                };

                conn.onmessage = function( event ) {
                    if(point_buffer.length < 30 ) {
                        var message = (typeof event.data === "string") ? event.data : JSON.parse( event.data );
                        $.xmlDOM(message).find('feed > entry > point').each(function() {
                            var latlon = $(this).text().split(" ");
                            myLatLng = new google.maps.LatLng(parseFloat(latlon[0]), parseFloat(latlon[1]));
                            point_buffer.push(new google.maps.Marker({ 
                                position: myLatLng, 
                            }));
                        });
                    }
                };

                conn.onclose = function( event ) {
                    // alert("closed!");
                };
            }
        }

        if (!window.WebSocket) {
            // Doh, Websockets not supported!
        } else {
            startConnection();
        }
    });
    </script>
</body> 
</html>