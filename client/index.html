<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
   "http://www.w3.org/TR/html4/loose.dtd"> 
<html lang="en"> 
  <head> 
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8"> 
    <title>Test</title> 
    <script type="text/javascript" src="http://www.google.com/jsapi"></script>  
    <script type="text/javascript">  
      google.load("jquery", "1.4.1");
      google.load("jqueryui", "1.7.2");
    </script> 
    <script type="text/javascript" src="jquery.cookie.js"></script>
    <script src="http://cdn.socket.io/stable/socket.io.js"></script>
<!--    <script type="text/javascript" src="websocket.js"></script>-->
  </head> 
 
  <body> 
<!--iframe does not solve reconnecting socket for new pages -->
<!--TODO: modify app in order that all functionality is in the same page via ajax? -->
<!--<iframe style="display:none;" type="text/html"
      src=""> 
</iframe>--> 
<!--    <script type="text/javascript" src="websocket.js"></script>-->
    

    <script type="text/javascript">
    
///////////////////////////////////////////////////////////////////////////////
// Helper functions
// TODO: move to another file
///////////////////////////////////////////////////////////////////////////////

function readCookie(name) {
	var nameEQ = name + "=";
	var ca = document.cookie.split(';');
	for(var i=0;i < ca.length;i++) {
		var c = ca[i];
		while (c.charAt(0)==' ') c = c.substring(1,c.length);
		if (c.indexOf(nameEQ) == 0) return c.substring(nameEQ.length,c.length);
	}
	return null;
}    
function createCookie(name,value,days) {
	if (days) {
		var date = new Date();
		date.setTime(date.getTime()+(days*24*60*60*1000));
		var expires = "; expires="+date.toGMTString();
	}
	else var expires = "";
	document.cookie = name+"="+value+expires+"; path=/";
}

///////////////////////////////////////////////////////////////////////////////
// Socket code
// TODO: move to a function?
///////////////////////////////////////////////////////////////////////////////

      var conn = {};
      var host = "localhost",
          port = 8080;
      var serverUri = "ws://"+host+":"+port;
      // REAL TIME PAGE REFRESH
      // TODO: authomaticaly include publisher notfications in the page
//      var feed        = document.getElementById('feed'),
//          form        = feed.form;

      // CHECK WHETHER SOCKETS SUPPORTED    
      if (!window.WebSocket) {
        console.debug("sockets not supported");
        // TODO: advice sockets not supported
        // if behind a firewall:
        //   advice it can not subscribe nor get updates
        // else:
        //   if want to subscribe (in add/following/x):
        //     call php function
      } else {
        console.debug("sockets supported");
        
        // CREATE NEW SOCKET
        conn = new WebSocket( serverUri );
        var conn = new io.Socket(host,{port: port});
        conn.connect(); 
        
        // ON SOCKET STABLISHED
        conn.on('connect',function() {
          console.debug("Socket opened");
          // while not solved that real hub subscription is done per socket:
          //   subscribe again followings:
          //   $followings = SMOBTools::followings();
          //   foreach($followings as $following) {
          //     var connection = {"hub.mode":"subscribe","hub.verify":"async","hub.callback":"<?php echo SMOB_ROOT.'callback'; ?>","hub.topic": "<?php echo $following['uri']; ?>"};
          //     conn.send(JSON.stringify(connection));
          //     $.get("add/following/$following['uri']", string, function(data){
          //       console.debug("adding following...");
          //     });
          
          // CHECK WHETHER COOKIE IN BROWSER
          var subscriberSID= readCookie('SID');
          if (subscriberSID) {
            console.debug("found cookie");
            console.debug(subscriberSID);
            // SEND COOKIE TO WEB SOCKET SERVER
            conn.send({SID: subscriberSID});
            console.debug("sent cookie");
          } else {
            // ASK FOR A COOKIE TO WEB SOCKET SERVER
            console.debug("no cookie");
            conn.send({SID: 0});
          }
        });

        // ON MESSAGE RECEIVED
        conn.on('message',function(data) {
          var string = data;
          console.debug("mesage received");

          // REAL TIME PAGE REFRESH
          //$('#messages').prepend("<pre class='sh_xml'><code>"+ code + "</code></pre>");
          //sh_highlightDocument(); 
          //if($('#messages').children().size() > 5) {
          //    $('#messages pre:last-child').remove();
          //}
          console.debug(string);
          
          try {
            // MESSAGE IS JSON
            json = JSON.parse(string);
            console.debug(json);
            if ( json.SID ) {
              console.debug(json.SID);
              createCookie("SID",json.SID);
              console.debug("stored cookie");
            };
          } catch(err) {
            // MESSAGE IS NOT JSON
            console.debug("no json", err);
          }
          
        });

        // DISCONNECT 
        conn.on('disconnect',function() {
          console.debug("socket closed");
        });
    }    
    </script>



    <div id="full"> 
      <div id="header"> 
      </div> 
      <div id="main"> 
        <div class="left">
            <form> 
            Are you sure you want to follow?
            <input type="submit" id="feed" value="Yes" /> 
            </form> 
        </div> 
        <div class="right"> 
        </div> 
        <div style="clear: both;"> </div> 
        </div> 
        <div id="footer"> 
        </div> 
    </div> 
  </body> 
</html> 
 
