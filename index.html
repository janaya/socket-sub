<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
   "http://www.w3.org/TR/html4/loose.dtd"> 
<html lang="en"> 
<head> 
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8"> 
    <title>PubSubHubbub and WebSockets</title>
    <meta name="author" content="Julien Genestoux"> 
    <!-- Javascript --> 
    <script src="http://ajax.googleapis.com/ajax/libs/jquery/1/jquery.min.js" type="text/javascript"></script> 
    <script src="http://superfeedr.com/javascripts/shjs-0.6/sh_main.min.js" type="text/javascript"></script> 
    <script src="http://superfeedr.com/javascripts/shjs-0.6/lang/sh_xml.min.js" type="text/javascript"></script> 
    <link href="http://superfeedr.com/stylesheets/shjs/sh_nedit.min.css" media="screen" rel="stylesheet" type="text/css" /> 
    <style>
    body { 
        font-family:helvetica; 
        background-color:#333; 
        color: white; 
        font-family:helvetica; 
        padding: 0px 10% 0px 10%; 
        font-size:1.2em;
    }
    a {
        color: white;
    }
    #feed { 
        font-size:1.2em;
        padding: 5px;
        margin:0px;
        width: 1000px; 
    }
    li {
        margin-bottom: 10px;
    }
    #messages { 
    }
    #status { 
        line-height: 30px;
        width: 20px;
        margin: 5px;
        color: red;
        font-size: 2.0em;
    }
    #messages code { 
        padding:5px;
    }
    
    #messages pre { 
        padding:5px;
        width: 1000px;
        display: block;
        overflow: hidden; 
    }
    
    #status.open   { color:green }
    #status.closed { color:red }
    #status.failed { color:red }
    #footer {
        width: 100%;
        font-size:1.2em;
    }
    #header a {
        color: white; 
    }
    #header img {
        padding: 0px 5px 0px 0px;
        vertical-align:middle;
        height:24px;
    }
    </style>
</head> 
<body> 
    <span id="header"> 
        Brought to you by <img src="http://www.gravatar.com/avatar/a2f7d4dd6df7dd59e4adab811c00a3a1?s=24"><a href="http://superfeedr.com" style="color:#CCC">Superfeedr</a> and <img src="http://a2.twimg.com/profile_images/1033553922/chromed_bigger.png"><a href="http://twitter.com/dshaw">Dshaw</a>, hosted by <img src="http://www.ajax.org/siteimg/octocat.png"><a href="http://github.com/">Github</a>
    </span> 
    
    <h1>PubSubHubbub and WebSockets</h1>
    <ul>
        <li>PubSubHubbub is a realtime web technology that allows Server to Server communication.</li>
        <li>WebSockets is a realtime web technology that allows Server to Client (browser, desktop, phone) communication.</li>
    </ul>
    <p>Combining both makes sense. This is what that is. <small>Use <a href="http://pubsubhubbub-example-app.appspot.com/feed"  target="_blank">this feed</a> and update it with <a href="http://pubsubhubbub-example-app.appspot.com" target="_blank">this app</a> if you're looking for feeds you can update. <a href="http://superfeedr.com/track/google" target="_blank">This feed</a> is also high frequency..</small></p>
    
    <form><input type=text id="feed" placeholder="Subscribe to a feed" /><span id="status" title="red x : server is not connected, green + : server is connected">x</span></form>
    <div id="messages">
            
    </div>
    
    <h2>What's happening?</h2>
    <ol>
        <li>When you type a feed url in there, your browser sends it to a websocket server</li>
        <li>When the server gets this request, it subscribes to a PubSubHubbub for this feed</li>
        <li>Later, when the feed is updated, the hub sends this update directly to the websocket server</li>
        <li>And finally, the server sends this new update to this page</li>
    </ol>
    
    <p>Check also this <a href="http://julien51.github.com/socket-sub/maps">other client</a>. You should clone run this <a href="http://github.com/julien51/socket-sub">server</a> on your own machine. You can also tweak <a href="http://github.com/julien51/socket-sub/blob/gh-pages/index.html">this page</a> (which is just a websocket client).</p>
    
    
    <script>
        $(document).ready(function() {
            var conn = {},
            serverUri,
            messages    = document.getElementById("messages"),
            state       = document.getElementById("status")
            feed        = document.getElementById('feed'),
            form        = feed.form;

            function spaces(len) {
                var s = '';
                var indent = len*4;
                for (i=0;i<indent;i++) {s += " ";}
                return s;
            }
            
            function format_xml(str) {
                var xml = '';
                // add newlines

                str = str.replace(/(>)(<)(\/*)/g,"$1\r$2$3");
                // add indents

                var pad = 0;
                var indent;
                var node;

                // split the string
                var strArr = str.split("\r");

                // check the various tag states
                for (var i = 0; i < strArr.length; i++) {
                    indent = 0;
                    node = strArr[i];

                    if(node.match(/.+<\/\w[^>]*>$/)){ //open and closing in the same line
                        indent = 0;
                    } else if(node.match(/^<\/\w/)){ // closing tag
                        if (pad > 0){pad -= 1;}
                    } else if (node.match(/^<\w[^>]*[^\/]>.*$/)){ //opening tag
                        indent = 1;
                    } else
                    indent = 0;

                    xml += spaces(pad) + node + "\r";
                    pad += indent;
                }
                return xml;
            }


            function startConnection() {
                var host = "node.superfeedr.com",
                port = 27261;
                serverUri = "ws://"+host+":"+port;
                openConnection();
            }

            function openConnection() {
                if ( !conn.readyState || conn.readyState > 1 ) {

                    conn = new WebSocket( serverUri );

                    conn.onopen = function () {
                        state.innerHTML = "+";
                        state.className = "open";
                    };

                    conn.onmessage = function( event ) {
                        var string = event.data;
                        var code = format_xml(string).replace(/></,'').replace(/\&/g,'&'+'amp;').replace(/</g,'&'+'lt;').replace(/>/g,'&'+'gt;').replace(/\'/g,'&'+'apos;').replace(/\"/g,'&'+'quot;')
                        $('#messages').prepend("<pre class='sh_xml'><code>"+ code + "</code></pre>");
                        sh_highlightDocument(); 
                        if($('#messages').children().size() > 5) {
                            $('#messages pre:last-child').remove();
                        }
                    };

                    conn.onclose = function( event ) {
                        state.innerHTML = "x";
                        state.className = "closed";
                    };
                }
            }

            if (!window.WebSocket) {
                state.innerHTML = "Sockets not supported";
                state.className = "failed";
            } else {
                form.addEventListener("submit", function (e) {
                    e.preventDefault();

                    // if web socket connected
                    if (conn.readyState === 1) {
                        var connection = {"feed_url": feed.value, "hub_url": "http://superfeedr.com/hubbub"};
                        conn.send(JSON.stringify(connection));
                        feed.value = "";
                    }
                }, false);

                startConnection();
            }
        });
    </script>
    <a href="http://github.com/julien51/socket-sub"><img style="position: absolute; top: 0; right: 0; border: 0;" src="http://s3.amazonaws.com/github/ribbons/forkme_right_orange_ff7600.png" alt="Fork me on GitHub" /></a> 
</body> 
</html>